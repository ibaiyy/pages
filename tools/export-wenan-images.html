<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å›¾ç‰‡æ–‡æ¡ˆç”Ÿæˆå™¨</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<!--        <script src="./../js/xlsx.full.min.js"></script>-->
<!--        <script src="./../js/html2canvas.min.js"></script>-->
        <link href="./../css/button.css" rel="stylesheet" type="text/css">
    <style>
        :root {
            --border-color: #e0e0e0;
            --bg-color: #f8f9fa;
            --title-color: #2d3436;
            --author-color: #636e72;
            --title-font-size: 66px;
            --content-font-size: 60px;
            --author-font-size: 56px;
        }

        body {
            padding: 20px;
            font-family: Arial, sans-serif;
            max-width: 80%;
            margin: 0 auto;
            background: white;
        }

        .config-panel {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .margin-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .size-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        .upload-box {
            border: 2px dashed #007bff;
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
            background: var(--bg-color);
        }

        .previews {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .preview-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background: white;
            /*width: 420px; !* æ–°å¢å›ºå®šå®½åº¦ *!*/
            height: 550px; /* æ–°å¢å›ºå®šé«˜åº¦ */
            overflow: hidden; /* éšè—æº¢å‡ºå†…å®¹ */

        }

        .preview-content {
            height: 400px;
            overflow: hidden;
            transform: scale(0.3);
            transform-origin: top left;
            width: 1245px;
            height: 1660px;
            transform-origin: 0 0; /* ç¡®ä¿ç¼©æ”¾åŸç‚¹æ­£ç¡® */
        }

        .template-container {
            width: 1245px;
            height: 1660px;
            padding: 40px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            box-sizing: border-box; /* ç¡®ä¿paddingä¸æ”¹å˜æ€»å°ºå¯¸ */
        }

        .title-section {
            font-size: var(--title-font-size);
            color: var(--title-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .content-section {
            font-size: var(--content-font-size);
            line-height: 1.8;
            color: var(--title-color);
            min-height: 1200px;
            /*margin-bottom: 30px;*/
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 30px;

            /* æ–°å¢å±…ä¸­å¸ƒå±€ */
            display: flex;
            flex-direction: column;
            justify-content: center;  /* å‚ç›´å±…ä¸­ */
            max-width: 80%;          /* æ§åˆ¶å†…å®¹å®½åº¦ */
            margin: 0 auto;          /* æ°´å¹³å±…ä¸­ */
        }

        /* æ®µè½ä¿æŒå·¦å¯¹é½ */
        .content-section p {
            text-align: left;
            width: 100%;
        }

        .author-section {
            font-size: var(--author-font-size);
            color: var(--author-color);
            text-align: right;
            margin-top: 25px;
        }

        .controls {
            margin: 5px;
            display: flex;
            justify-content: space-between;
        }

        .loader {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .color-controls {
            margin: 15px 0;
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
<h1>ğŸ“± ç”Ÿæˆå™¨</h1>

<div class="config-panel">
    <h3>è¾¹è·è®¾ç½® (åƒç´ )</h3>
    <div class="margin-inputs">
        <input type="number" id="top" placeholder="ä¸Šè¾¹è· (é»˜è®¤100)" min="0">
        <input type="number" id="right" placeholder="å³è¾¹è· (é»˜è®¤60)" min="0">
        <input type="number" id="bottom" placeholder="ä¸‹è¾¹è· (é»˜è®¤60)" min="0">
        <input type="number" id="left" placeholder="å·¦è¾¹è· (é»˜è®¤60)" min="0">
    </div>
    <button onclick="applySettings()" class="btn-default">åº”ç”¨è®¾ç½®</button>
    <button onclick="downloadAll()" id="batchDownload" class="btn-primary">å…¨éƒ¨ä¸‹è½½</button>

    <h3 style="margin-top:15px">é…è‰²æ–¹æ¡ˆ</h3>
    <div class="color-controls">
        <button onclick="document.getElementById('bgColor').click()" class="btn-default">èƒŒæ™¯é¢œè‰²</button>
        <button onclick="document.getElementById('textColor').click()" class="btn-default">æ–‡å­—é¢œè‰²</button>
        <button onclick="document.getElementById('borderColor').click()" class="btn-default">è¾¹æ¡†é¢œè‰²</button>

        <input type="color" id="bgColor" hidden>
        <input type="color" id="textColor" hidden>
        <input type="color" id="borderColor" hidden>
    </div>

    <h3>æ–‡å­—å°ºå¯¸è®¾ç½® (px)</h3>
    <div class="size-controls">
        <input type="number" id="titleSize" placeholder="æ ‡é¢˜ (é»˜è®¤66)" min="20">
        <input type="number" id="contentSize" placeholder="æ­£æ–‡ (é»˜è®¤60)" min="20">
        <input type="number" id="authorSize" placeholder="ä½œè€… (é»˜è®¤56)" min="20">
    </div>
</div>

<div class="upload-box">
    <p>æ‹–æ”¾Excelæ–‡ä»¶æˆ– <button onclick="document.getElementById('file').click()" class="btn-default">é€‰æ‹©æ–‡ä»¶</button></p>
    <input type="file" id="file" accept=".xlsx,.xls" hidden>
</div>

<div class="previews" id="previews"></div>

<script>
    // å…¨å±€çŠ¶æ€ç®¡ç†
    let isExporting = false;

    let articles = [];
    let margins = { top: 100, right: 60, bottom: 60, left: 60 };

    // åˆå§‹åŒ–äº‹ä»¶
    document.getElementById('file').addEventListener('change', handleFile);
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', e => {
        e.preventDefault();
        if(e.dataTransfer.files) {
            document.getElementById('file').files = e.dataTransfer.files;
            handleFile();
        }
    });

    // åˆå§‹åŒ–é»˜è®¤é¢œè‰²
    document.documentElement.style.setProperty('--bg-color', '#f8f9fa');
    document.documentElement.style.setProperty('--title-color', '#2d3436');
    document.documentElement.style.setProperty('--border-color', '#e0e0e0');

    // é¢œè‰²é€‰æ‹©äº‹ä»¶ç›‘å¬
    document.getElementById('bgColor').addEventListener('input', function(e) {
        document.documentElement.style.setProperty('--bg-color', e.target.value);
        renderPreviews();
    });

    document.getElementById('textColor').addEventListener('input', function(e) {
        document.documentElement.style.setProperty('--title-color', e.target.value);
        document.documentElement.style.setProperty('--author-color', e.target.value);
        renderPreviews();
    });

    document.getElementById('borderColor').addEventListener('input', function(e) {
        document.documentElement.style.setProperty('--border-color', e.target.value);
        renderPreviews();
    });


    // åˆå§‹åŒ–é»˜è®¤å€¼
    document.getElementById('titleSize').value = 66;
    document.getElementById('contentSize').value = 60;
    document.getElementById('authorSize').value = 56;

    // æ–‡å­—å¤§å°æ”¹å˜äº‹ä»¶
    document.querySelectorAll('.size-controls input').forEach(input => {
        input.addEventListener('change', function() {
            const value = this.value ? `${this.value}px` : this.placeholder;

            switch(this.id) {
                case 'titleSize':
                    document.documentElement.style.setProperty('--title-font-size', value);
                    break;
                case 'contentSize':
                    document.documentElement.style.setProperty('--content-font-size', value);
                    break;
                case 'authorSize':
                    document.documentElement.style.setProperty('--author-font-size', value);
                    break;
            }

            // ç«‹å³é¢„è§ˆæ›´æ–°
            renderPreviews();
        });
    });


    async function handleFile() {
        const file = document.getElementById('file').files[0];
        if(!file) return;

        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: ['A', 'B', 'C'] });

        articles = json
            .filter(row => row.A && row.B && row.C)
            .map(row => ({
                title: row.A.toString().trim(),
                content: row.B.toString().trim(),
                author: row.C.toString().trim()
            }));

        renderPreviews();
    }

    function applySettings() {
        margins = {
            top: parseInt(document.getElementById('top').value) || 40,
            right: parseInt(document.getElementById('right').value) || 40,
            bottom: parseInt(document.getElementById('bottom').value) || 40,
            left: parseInt(document.getElementById('left').value) || 40
        };
        renderPreviews();
    }

    function renderPreviews() {
        const container = document.getElementById('previews');
        container.innerHTML = '';

        articles.forEach((article, index) => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `
                    <div class="controls">
                         <button onclick="exportArticle(${index})" class="btn-default">å•å¼ ä¸‹è½½(${index + 1})</button>
                    </div>
                    <div class="preview-content">
                        ${createTemplate(article).outerHTML}
                    </div>
                `;
            container.appendChild(div);
        });
    }

    function createTemplate(article) {
        const div = document.createElement('div');
        div.className = 'template-container';
        div.style.padding = `${margins.top}px ${margins.right}px ${margins.bottom}px ${margins.left}px`;

        div.innerHTML = `
                <div class="title-section">${article.title}</div>
                <div class="content-section">${formatContent(article.content)}</div>
                <div class="author-section">â€”â€” ${article.author}</div>
            `;

        return div;
    }

    function formatContent(text) {
        return text.split('\n')
            .map(p => `<p style="margin: 20px 0">${p}</p>`)
            .join('');
    }

    async function exportArticle(index, isBatch = false) {
        if(isExporting && !isBatch) return;

        const original = document.querySelectorAll('.preview-content')[index];
        const tempDiv = document.createElement('div');
        tempDiv.style.cssText = `
        position: fixed;
        left: -9999px;
        width: 1245px;
        height: 1660px;
        visibility: visible !important;
    `;

        const clone = original.cloneNode(true);
        clone.style.transform = 'none';
        clone.style.opacity = '1';
        tempDiv.appendChild(clone);
        document.body.appendChild(tempDiv);

        try {
            const canvas = await html2canvas(clone.firstElementChild, {
                scale: 1,
                useCORS: true,
                width: 1245,       // æ˜ç¡®æŒ‡å®šç”»å¸ƒå°ºå¯¸
                height: 1660,
                windowWidth: 1245, // æ–°å¢çª—å£å°ºå¯¸
                windowHeight: 1660,
                logging: false
            });

            const link = document.createElement('a');
            link.download = `æ–‡æ¡ˆ-${index + 1}.png`;
            link.href = canvas.toDataURL();

            if(!isBatch) {
                link.click();
            } else {
                // æ‰¹é‡ä¸‹è½½ä½¿ç”¨å»¶æ—¶è§¦å‘
                setTimeout(() => {
                    link.click();
                    URL.revokeObjectURL(link.href);
                }, index * 1000);
            }
        } finally {
            document.body.removeChild(tempDiv);
        }
    }

    async function downloadAll() {
        if(isExporting) return;

        isExporting = true;
        const btn = document.querySelector('#batchDownload');
        btn.disabled = true;
        btn.innerHTML = '<div class="loader"></div> ç”Ÿæˆä¸­...';

        try {
            for(let i = 0; i < articles.length; i++) {
                await exportArticle(i, true);
                await new Promise(r => setTimeout(r, 500)); // å¢åŠ é—´éš”é˜²æ­¢é˜»å¡
            }
        } catch (error) {
            console.error('æ‰¹é‡å¯¼å‡ºå¤±è´¥:', error);
            alert('éƒ¨åˆ†å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
        } finally {
            isExporting = false;
            btn.disabled = false;
            btn.textContent = 'å…¨éƒ¨ä¸‹è½½';
        }
    }
</script>
</body>
</html>